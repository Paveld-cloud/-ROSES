<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</title>
    <link rel="stylesheet" href="/static/assets/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h1>
            <button id="refreshBtn" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </header>

        <main>
            <div id="favoritesList" class="roses-grid">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ...</div>
            </div>
        </main>
    </div>

    <script src="/static/assets/script.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const favoritesList = document.getElementById('favoritesList');

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        async function loadFavorites(chatId) {
            showLoading(favoritesList);
            try {
                const response = await fetch(`/app/favorites?chat_id=${chatId}`);
                const data = await response.json();
                
                if (data.favorites) {
                    displayFavorites(data.favorites, favoritesList);
                } else {
                    showError(favoritesList, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError(favoritesList, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        function showLoading(container) {
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ...</div>';
        }

        function showError(container, message) {
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        function displayFavorites(favorites, container) {
            if (favorites.length === 0) {
                container.innerHTML = '<div class="empty-state">üíî –£ –≤–∞—Å –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ä–æ–∑</div>';
                return;
            }
            
            container.innerHTML = favorites.map(rose => `
                <div class="rose-card">
                    ${rose.photo ? `<img src="${rose.photo}" alt="${rose.name}" class="rose-image" onerror="this.style.display='none'">` : ''}
                    <div class="rose-info">
                        <h3 class="rose-name">${rose.name}</h3>
                        <p class="rose-description">${truncateText(rose.description, 100)}</p>
                        <div class="rose-actions">
                            <button class="btn btn-care" onclick="showCare('${rose.id}')">ü™¥ –£—Ö–æ–¥</button>
                            <button class="btn btn-history" onclick="showHistory('${rose.id}')">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCare(roseId) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑ –¥–µ—Ç–∞–ª–µ–π —É—Ö–æ–¥–∞
            tg.showAlert('ü™¥ –§—É–Ω–∫—Ü–∏—è —É—Ö–æ–¥–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function showHistory(roseId) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑ –∏—Å—Ç–æ—Ä–∏–∏
            tg.showAlert('üìú –§—É–Ω–∫—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.showCare = showCare;
        window.showHistory = showHistory;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–∞ –∏–∑ Telegram Web App
            const tg = window.Telegram.WebApp;
            tg.expand();
            
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const chatId = tg.initDataUnsafe.user.id;
                loadFavorites(chatId);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                document.getElementById('refreshBtn').addEventListener('click', function() {
                    loadFavorites(chatId);
                });
            } else {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑ initData, –ø–æ–ø—Ä–æ–±—É–µ–º –∏–∑ URL
                const urlParams = new URLSearchParams(window.location.search);
                const chatId = urlParams.get('chat_id');
                if (chatId) {
                    loadFavorites(chatId);
                } else {
                    document.getElementById('favoritesList').innerHTML = 
                        '<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
                }
            }
        });
    </script>
</body>
</html>
